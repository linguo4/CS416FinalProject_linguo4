<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>

<!-- Initialize a select button -->
<select id="selectButton"></select>

<!-- Load d3-annotation -->
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>

<!-- Color Scale -->
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<!-- Circle are black when hovered-->
<style>
.myCircle:hover {
  stroke: black;
}
</style>

<p>This interactive slideshow consists of three scenes showing the change on percent of people staying at home before and after COVID-19 from Jan 2019 to Jun 2021. 
  With the dropdown box on the left corner, the scene can be switched from US to IL, and then to Champaign. 
  With zooming in, we can find the difference and local characters on the staying-at-home percentage. 
  With different scenes, we can find some similarities and differences. 
  (To check the tool tips on the US level, please switch to other level then switch back to make it function.)</p>

<p>Similarities</p>

<p>1. The similarities include the general trends of high-rising percentage around April and May 2020, when most states started their staying at home order. 
  While it dropped back to normal immediately after the order was canceled, the percent still went up afterwards, perhaps due to civilians' 
  realization in the up-rising number of cases per day.</p>
<p>2. The second similarity lies in the high-rising percentage around November when winter comes. Starting January, it went down with the spread of vaccination.</p>

<p>Differences</p>

<p>1. From the general trend we can find more fluctuation happens when switching from US to IL and to Champaign, following the law of large numbers. And IL has a higher percent of people
staying at home, both before and after the initialization of COVID-19, over US, and Champaign has a higher percentage over IL.</p>

<p>2. As the annotation pointed, the two events have higher percentage for IL and Champaign than US, indicating a better enforcement of staying-at-home order in IL 
and the colder winter in IL across the United States.</p>

<p>3. The third difference is that Champaign's percentage is still going down after May 2021 while IL's and US's are going up and then keeping a steady level.</p>



<script>
d3.select("body").append("p");
// set the dimensions and margins of the graph
var margin = {top: 10, right: 100, bottom: 30, left: 50},
    width = 1800 - margin.left - margin.right,
    height = 700 - margin.top - margin.bottom;

// append the svg object to the body of the page
var svg = d3.select("#my_dataviz")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

  


//Read the data
d3.csv("https://linguo4.github.io/CS416FinalProject_linguo4/Trips_by_Distance.csv", function(d){
    return { date : d3.timeParse("%m/%d/%Y")(d.Date), US : d.Stay_at_home_ratio_National, IL : d.Stay_at_home_ratio_IL, Champaign : d.Stay_at_home_ratio_Champaign }
  },
  function(data) {
    
    // List of groups (here I have one group per column)
    var allGroup = ["US", "IL", "Champaign"]

    // add the options to the button
    d3.select("#selectButton")
      .selectAll('myOptions')
     	.data(allGroup)
      .enter()
    	.append('option')
      .text(function (d) { return d; }) // text showed in the menu
      .attr("value", function (d) { return d; }) // corresponding value returned by the button

    // Add X axis --> it is a date format
    var x = d3.scaleTime()
      .domain(d3.extent(data, function(d) { return d.date; }))
      .range([ 0, width ]);
    svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x));
    svg.append("text")             
      .attr("transform",
            "translate(" + (width/2) + " ," + 
                           (height + margin.top + 20) + ")")
      .style("text-anchor", "middle")
      .text("Time");

    // Add Y axis
    var y = d3.scaleLinear()
      .domain( [15, 40])
      .range([ height, 0 ]);
    svg.append("g")
      .call(d3.axisLeft(y));
  
    svg.append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 0 - margin.left)
      .attr("x",0 - (height / 2))
      .attr("dy", "1em")
      .style("text-anchor", "middle")
      .text("Percentage(%) of people staying at home");
  
  
    svg.append("text")
        .attr("x", (width / 2))             
        .attr("y", 10 - (margin.top / 2))
        .attr("text-anchor", "middle")  
        .style("font-size", "16px") 
        .style("text-decoration", "underline")  
        .text("Percent of people staying at home vs Time Graph");
  
    // Initialize line with group a
    var line = svg
      .append('g')
      .append("path")
        .datum(data)
        .attr("d", d3.line()
          .x(function(d) { return x(d.date) })
          .y(function(d) { return y(d.US) })
        )
        .attr("stroke", "black")
        .style("stroke-width", 2)
        .style("fill", "none")
    
    // create a tooltip
    var Tooltip = d3.select("#my_dataviz")
      .append("div")
      .style("opacity", 0)
      .attr("class", "tooltip")
      .style("background-color", "white")
      .style("border", "solid")
      .style("border-width", "2px")
      .style("border-radius", "5px")
      .style("padding", "5px")

      // Three function that change the tooltip when user hover / move / leave a cell
      var mouseover = function(d) {
        Tooltip
          .style("opacity", 1)
      }
      
      var mousemove_init = function(d) {
        Tooltip
          .html("Staying at home percentage: " + d.US + "%")
          .style("left", (d3.mouse(this)[0]+70) + "px")
          .style("top", (d3.mouse(this)[1]) + "px")
      }
      
      var mousemove = function(d) {
        Tooltip
          .html("Staying at home percentage: " + d.value + "%")
          .style("left", (d3.mouse(this)[0]+70) + "px")
          .style("top", (d3.mouse(this)[1]) + "px")
      }
      
      var mouseleave = function(d) {
        Tooltip
          .style("opacity", 0)
      }
     
  
  
    // Initialize dots with group a
    var dot = svg
      .append("g")
      .selectAll('dot')
      .data(data)
      .enter()
      .append('circle')
        .attr("class","myCircle")
        .attr("cx", function(d) { return x(d.date) })
        .attr("cy", function(d) { return y(d.US) })
        .attr("r", 5)
        .attr("stroke", "#69b3a2")
        .attr("stroke-width", 3)
        .attr("fill", "white")
        .on("mouseover", mouseover)
        .on("mousemove", mousemove)
        .on("mouseleave", mouseleave)
    
//     var text = svg.append("text")
//       .attr("x", 0 - margin.left)             
//       .attr("y", 10 - (margin.top / 2))
//       .attr("text-anchor", "start")  
//       .style("font-size", "16px");

    
    
    
    
    const annotations1 = [
        {
          note: {
            label: "IL published start of staying at home order.",
            title: "Staying at home order."
          },
          x: 850,
          y: 250,
          dy: -50,
          dx: 100
        }
      ]
      // Add annotation to the chart
      
  

      
      const annotations2 = [
        {
          note: {
            label: "It's colder outside for IL and more people like to stay inside than national average.",
            title: "Winter is coming!"
          },
          x: 1250,
          y: 250,
          dy: -80,
          dx: 100
        }
      ]
      
      const annotations3 = [
        {
          note: {
            label: "Champaign's percentage is going down while US's and IL's are going up and keeping steady afterwards.",
            title: "Still going down!"
          },
          x: 1540,
          y: 500,
          dy: -200,
          dx: 0
        }
      ]
      
      const annotations4 = [
        {
          note: {
            label: "Start of COVID-19 in US.",
            title: "Warning!"
          },
          x: 700,
          y: 500,
          dy: -300,
          dx: 0
        }
      ]
  
    const makeAnnotations1 = d3.annotation()
          .annotations(annotations1)
  
    const makeAnnotations2 = d3.annotation()
          .annotations(annotations2)
    const makeAnnotations3 = d3.annotation()
          .annotations(annotations3)
  
    const makeAnnotations4 = d3.annotation()
          .annotations(annotations4)
        svg.append("g")
          .call(makeAnnotations4)
  
    // A function that update the chart
    function update(selectedGroup) {

      // Create new data with the selection?
      var dataFilter = data.map(function(d){return {time: d.date, value:d[selectedGroup]} })

      // Give these new data to update line
      line
          .datum(dataFilter)
          .transition()
          .duration(1000)
          .attr("d", d3.line()
            .x(function(d) { return x(d.time) })
            .y(function(d) { return y(d.value) })
          )
      dot
        .data(dataFilter)
        .transition()
        .duration(1000)
          .attr("cx", function(d) { return x(d.time) })
          .attr("cy", function(d) { return y(d.value) })
//           .on("mouseover", mouseover)
//           .on("mousemove", mousemove)
//           .on("mouseleave", mouseleave)
      if (selectedGroup=='Champaign'){    
        svg.append("g")
          .call(makeAnnotations3)
      }
      if (selectedGroup=='IL'){  
        svg.append("g")
          .call(makeAnnotations1)
        svg.append("g")
          .call(makeAnnotations2)
      }
      
      
    }
  
  
      
    

    // When the button is changed, run the updateChart function
    d3.select("#selectButton").on("change", function(d) {
        // recover the option that has been chosen
        var selectedOption = d3.select(this).property("value")
        // run the updateChart function with this selected option
        update(selectedOption)
    })
  
  
    

})
  


</script>
